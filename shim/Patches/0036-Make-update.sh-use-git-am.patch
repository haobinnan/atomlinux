From b3e4d1f7555aabbf5d54de5ea7cd7e839e7bd83d Mon Sep 17 00:00:00 2001
From: Peter Jones <pjones@redhat.com>
Date: Tue, 9 Oct 2018 10:39:17 -0400
Subject: [PATCH 36/55] Make update.sh use git am

Signed-off-by: Peter Jones <pjones@redhat.com>
---
 .../0001-Cryptlib-update-for-efi-build.patch  |  61 +++++++++++
 ...2-Cryptlib-work-around-new-CA-rules.patch} |  15 ++-
 ...k-CryptX509.c-Fix-RETURN_-to-be-EFI_.patch | 101 ++++++++++++++++++
 Cryptlib/Cryptlib.diff                        |  73 -------------
 ...001-OpenSSL-bio-b_print-disable-SSE.patch} |  32 ++++--
 ...nSSL-Pk7-smime-add-an-error-message.patch} |  14 ++-
 Cryptlib/OpenSSL/update.sh                    |  33 +++++-
 Cryptlib/opensslconf-diff.patch               |  24 -----
 Cryptlib/update.sh                            |  51 ++++++++-
 9 files changed, 287 insertions(+), 117 deletions(-)
 create mode 100644 Cryptlib/0001-Cryptlib-update-for-efi-build.patch
 rename Cryptlib/{ca-check-workaround.patch => 0002-Cryptlib-work-around-new-CA-rules.patch} (76%)
 create mode 100644 Cryptlib/0003-Cryptlib-Pk-CryptX509.c-Fix-RETURN_-to-be-EFI_.patch
 delete mode 100644 Cryptlib/Cryptlib.diff
 rename Cryptlib/OpenSSL/{openssl-bio-b_print-disable-sse.patch => 0001-OpenSSL-bio-b_print-disable-SSE.patch} (70%)
 rename Cryptlib/OpenSSL/{openssl-pk7-smime-error-message.patch => 0002-OpenSSL-Pk7-smime-add-an-error-message.patch} (58%)
 delete mode 100644 Cryptlib/opensslconf-diff.patch

diff --git a/Cryptlib/0001-Cryptlib-update-for-efi-build.patch b/Cryptlib/0001-Cryptlib-update-for-efi-build.patch
new file mode 100644
index 0000000..8a86d60
--- /dev/null
+++ b/Cryptlib/0001-Cryptlib-update-for-efi-build.patch
@@ -0,0 +1,61 @@
+From ca76f590848a50a7b9f98ba562aabe7919c8b40f Mon Sep 17 00:00:00 2001
+From: "dunno@dunno" <dunno@dunno>
+Date: Tue, 9 Oct 2018 10:40:06 -0400
+Subject: [PATCH 1/4] Cryptlib: update for efi build
+
+---
+ Cryptlib/SysCall/CrtWrapper.c   | 14 --------------
+ Cryptlib/SysCall/TimerWrapper.c |  4 +---
+ 2 files changed, 1 insertion(+), 17 deletions(-)
+
+diff --git a/Cryptlib/SysCall/CrtWrapper.c b/Cryptlib/SysCall/CrtWrapper.c
+index 9510a4a383e..0b9f9e72f76 100644
+--- a/Cryptlib/SysCall/CrtWrapper.c
++++ b/Cryptlib/SysCall/CrtWrapper.c
+@@ -384,20 +384,6 @@ size_t fwrite (const void *buffer, size_t size, size_t count, FILE *stream)
+   return 0;
+ }
+ 
+-//
+-//  -- Dummy OpenSSL Support Routines --
+-//
+-
+-int BIO_printf (void *bio, const char *format, ...)
+-{
+-  return 0;
+-}
+-
+-int BIO_snprintf(char *buf, size_t n, const char *format, ...)
+-{
+-  return 0;
+-}
+-
+ #ifdef __GNUC__
+ 
+ typedef
+diff --git a/Cryptlib/SysCall/TimerWrapper.c b/Cryptlib/SysCall/TimerWrapper.c
+index 5f9b0c20d75..1ef3731faed 100644
+--- a/Cryptlib/SysCall/TimerWrapper.c
++++ b/Cryptlib/SysCall/TimerWrapper.c
+@@ -13,9 +13,7 @@ WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.
+ 
+ **/
+ 
+-#include <Uefi.h>
+ #include <CrtLibSupport.h>
+-#include <Library/UefiRuntimeServicesTableLib.h>
+ 
+ //
+ // -- Time Management Routines --
+@@ -80,7 +78,7 @@ time_t time (time_t *timer)
+   //
+   // Get the current time and date information
+   //
+-  Status = gRT->GetTime (&Time, NULL);
++  Status = uefi_call_wrapper(gRT->GetTime, 2, &Time, NULL);
+   if (EFI_ERROR (Status) || (Time.Year < 1970)) {
+     return 0;
+   }
+-- 
+2.17.1
+
diff --git a/Cryptlib/ca-check-workaround.patch b/Cryptlib/0002-Cryptlib-work-around-new-CA-rules.patch
similarity index 76%
rename from Cryptlib/ca-check-workaround.patch
rename to Cryptlib/0002-Cryptlib-work-around-new-CA-rules.patch
index 752528b..48a4666 100644
--- a/Cryptlib/ca-check-workaround.patch
+++ b/Cryptlib/0002-Cryptlib-work-around-new-CA-rules.patch
@@ -1,5 +1,14 @@
+From 18f2f93416a3c35111225edb55ac40ffc1181a52 Mon Sep 17 00:00:00 2001
+From: "dunno@dunno" <dunno@dunno>
+Date: Tue, 9 Oct 2018 10:40:06 -0400
+Subject: [PATCH 3/4] Cryptlib: work around new CA rules
+
+---
+ Cryptlib/Pk/CryptPkcs7Verify.c | 39 ++++++++++++++++++++++++++++++++++
+ 1 file changed, 39 insertions(+)
+
 diff --git a/Cryptlib/Pk/CryptPkcs7Verify.c b/Cryptlib/Pk/CryptPkcs7Verify.c
-index bf24e92..cbd9669 100644
+index fe8e5950f9f..219c2bb1096 100644
 --- a/Cryptlib/Pk/CryptPkcs7Verify.c
 +++ b/Cryptlib/Pk/CryptPkcs7Verify.c
 @@ -30,6 +30,43 @@ WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.
@@ -46,7 +55,7 @@ index bf24e92..cbd9669 100644
  /**
    Check input P7Data is a wrapped ContentInfo structure or not. If not construct
    a new structure to wrap P7Data.
-@@ -858,6 +895,8 @@ Pkcs7Verify (
+@@ -866,6 +903,8 @@ Pkcs7Verify (
      goto _Exit;
    }
  
@@ -56,5 +65,5 @@ index bf24e92..cbd9669 100644
    // For generic PKCS#7 handling, InData may be NULL if the content is present
    // in PKCS#7 structure. So ignore NULL checking here.
 -- 
-2.14.2
+2.17.1
 
diff --git a/Cryptlib/0003-Cryptlib-Pk-CryptX509.c-Fix-RETURN_-to-be-EFI_.patch b/Cryptlib/0003-Cryptlib-Pk-CryptX509.c-Fix-RETURN_-to-be-EFI_.patch
new file mode 100644
index 0000000..38c9847
--- /dev/null
+++ b/Cryptlib/0003-Cryptlib-Pk-CryptX509.c-Fix-RETURN_-to-be-EFI_.patch
@@ -0,0 +1,101 @@
+From c3edecb4a79fd8ceadf7653e1c9ae38979df2d6d Mon Sep 17 00:00:00 2001
+From: Peter Jones <pjones@redhat.com>
+Date: Tue, 9 Oct 2018 11:18:12 -0400
+Subject: [PATCH 4/4] Cryptlib: Pk/CryptX509.c: Fix RETURN_* to be EFI_*
+
+Signed-off-by: Peter Jones <pjones@redhat.com>
+---
+ Cryptlib/Pk/CryptX509.c | 28 +++++++++++++++-------------
+ 1 file changed, 15 insertions(+), 13 deletions(-)
+
+diff --git a/Cryptlib/Pk/CryptX509.c b/Cryptlib/Pk/CryptX509.c
+index 75337ed32bb..bca97630555 100644
+--- a/Cryptlib/Pk/CryptX509.c
++++ b/Cryptlib/Pk/CryptX509.c
+@@ -311,19 +311,19 @@ _Exit:
+                                    If CommonName is NULL then the amount of space needed
+                                    in buffer (including the final null) is returned.
+ 
+-  @retval RETURN_SUCCESS           The certificate CommonName retrieved successfully.
+-  @retval RETURN_INVALID_PARAMETER If Cert is NULL.
++  @retval EFI_SUCCESS           The certificate CommonName retrieved successfully.
++  @retval EFI_INVALID_PARAMETER If Cert is NULL.
+                                    If CommonNameSize is NULL.
+                                    If CommonName is not NULL and *CommonNameSize is 0.
+                                    If Certificate is invalid.
+-  @retval RETURN_NOT_FOUND         If no CommonName entry exists.
+-  @retval RETURN_BUFFER_TOO_SMALL  If the CommonName is NULL. The required buffer size
++  @retval EFI_NOT_FOUND         If no CommonName entry exists.
++  @retval EFI_BUFFER_TOO_SMALL  If the CommonName is NULL. The required buffer size
+                                    (including the final null) is returned in the
+                                    CommonNameSize parameter.
+-  @retval RETURN_UNSUPPORTED       The operation is not supported.
++  @retval EFI_UNSUPPORTED       The operation is not supported.
+ 
+ **/
+-RETURN_STATUS
++EFI_STATUS
+ EFIAPI
+ X509GetCommonName (
+   IN      CONST UINT8  *Cert,
+@@ -332,7 +332,7 @@ X509GetCommonName (
+   IN OUT  UINTN        *CommonNameSize
+   )
+ {
+-  RETURN_STATUS    ReturnStatus;
++  EFI_STATUS    ReturnStatus;
+   BOOLEAN          Status;
+   X509             *X509Cert;
+   X509_NAME        *X509Name;
+@@ -342,7 +342,7 @@ X509GetCommonName (
+   ASN1_STRING      *EntryData;
+   UINT8            *UTF8Name;
+ 
+-  ReturnStatus = RETURN_INVALID_PARAMETER;
++  ReturnStatus = EFI_INVALID_PARAMETER;
+   UTF8Name     = NULL;
+ 
+   //
+@@ -389,7 +389,7 @@ X509GetCommonName (
+     // No CommonName entry exists in X509_NAME object
+     //
+     *CommonNameSize = 0;
+-    ReturnStatus    = RETURN_NOT_FOUND;
++    ReturnStatus    = EFI_NOT_FOUND;
+     goto _Exit;
+   }
+ 
+@@ -399,7 +399,7 @@ X509GetCommonName (
+     // Fail to retrieve name entry data
+     //
+     *CommonNameSize = 0;
+-    ReturnStatus    = RETURN_NOT_FOUND;
++    ReturnStatus    = EFI_NOT_FOUND;
+     goto _Exit;
+   }
+ 
+@@ -411,18 +411,18 @@ X509GetCommonName (
+     // Fail to convert the commonName string
+     //
+     *CommonNameSize = 0;
+-    ReturnStatus    = RETURN_INVALID_PARAMETER;
++    ReturnStatus    = EFI_INVALID_PARAMETER;
+     goto _Exit;
+   }
+ 
+   if (CommonName == NULL) {
+     *CommonNameSize = Length + 1;
+-    ReturnStatus = RETURN_BUFFER_TOO_SMALL;
++    ReturnStatus = EFI_BUFFER_TOO_SMALL;
+   } else {
+     *CommonNameSize = MIN ((UINTN)Length, *CommonNameSize - 1) + 1;
+     CopyMem (CommonName, UTF8Name, *CommonNameSize - 1);
+     CommonName[*CommonNameSize - 1] = '\0';
+-    ReturnStatus = RETURN_SUCCESS;
++    ReturnStatus = EFI_SUCCESS;
+   }
+ 
+ _Exit:
+-- 
+2.17.1
+
diff --git a/Cryptlib/Cryptlib.diff b/Cryptlib/Cryptlib.diff
deleted file mode 100644
index 5a56470..0000000
--- a/Cryptlib/Cryptlib.diff
+++ /dev/null
@@ -1,73 +0,0 @@
-diff --git a/Cryptlib/Include/openssl/e_os2.h b/Cryptlib/Include/openssl/e_os2.h
-index 99ea347..f11cffe 100644
---- a/Cryptlib/Include/openssl/e_os2.h
-+++ b/Cryptlib/Include/openssl/e_os2.h
-@@ -234,6 +234,7 @@ extern "C" {
- 
- /* Standard integer types */
- # if defined(OPENSSL_SYS_UEFI)
-+#include <efi.h>
- typedef INT8 int8_t;
- typedef UINT8 uint8_t;
- typedef INT16 int16_t;
-diff --git a/Cryptlib/SysCall/BaseMemAllocation.c b/Cryptlib/SysCall/BaseMemAllocation.c
-index f390e0d..65e9938 100644
---- a/Cryptlib/SysCall/BaseMemAllocation.c
-+++ b/Cryptlib/SysCall/BaseMemAllocation.c
-@@ -33,7 +33,7 @@ void *realloc (void *ptr, size_t size)
-   // BUG: hardcode OldSize == size! We have no any knowledge about
-   // memory size of original pointer ptr.
-   //
--  return ReallocatePool ((UINTN) size, (UINTN) size, ptr);
-+  return ReallocatePool (ptr, (UINTN) size, (UINTN) size);
- }
- 
- /* De-allocates or frees a memory block */
-diff --git a/Cryptlib/SysCall/CrtWrapper.c b/Cryptlib/SysCall/CrtWrapper.c
-index 20c9656..7878953 100644
---- a/Cryptlib/SysCall/CrtWrapper.c
-+++ b/Cryptlib/SysCall/CrtWrapper.c
-@@ -371,20 +371,6 @@ size_t fwrite (const void *buffer, size_t size, size_t count, FILE *stream)
-   return 0;
- }
- 
--//
--//  -- Dummy OpenSSL Support Routines --
--//
--
--int BIO_printf (void *bio, const char *format, ...)
--{
--  return 0;
--}
--
--int BIO_snprintf(char *buf, size_t n, const char *format, ...)
--{
--  return 0;
--}
--
- #ifdef __GNUC__
- 
- typedef
-diff --git a/Cryptlib/SysCall/TimerWrapper.c b/Cryptlib/SysCall/TimerWrapper.c
-index 581b8fb..04fe4ef 100644
---- a/Cryptlib/SysCall/TimerWrapper.c
-+++ b/Cryptlib/SysCall/TimerWrapper.c
-@@ -13,9 +13,7 @@ WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.
- 
- **/
- 
--#include <Uefi.h>
- #include <CrtLibSupport.h>
--#include <Library/UefiRuntimeServicesTableLib.h>
- 
- //
- // -- Time Management Routines --
-@@ -79,7 +77,7 @@ time_t time (time_t *timer)
-   //
-   // Get the current time and date information
-   //
--  gRT->GetTime (&Time, NULL);
-+  uefi_call_wrapper(RT->GetTime, 2, &Time, NULL);
- 
-   //
-   // Years Handling
diff --git a/Cryptlib/OpenSSL/openssl-bio-b_print-disable-sse.patch b/Cryptlib/OpenSSL/0001-OpenSSL-bio-b_print-disable-SSE.patch
similarity index 70%
rename from Cryptlib/OpenSSL/openssl-bio-b_print-disable-sse.patch
rename to Cryptlib/OpenSSL/0001-OpenSSL-bio-b_print-disable-SSE.patch
index 2b1fc5b..3da0486 100644
--- a/Cryptlib/OpenSSL/openssl-bio-b_print-disable-sse.patch
+++ b/Cryptlib/OpenSSL/0001-OpenSSL-bio-b_print-disable-SSE.patch
@@ -1,11 +1,20 @@
+From df6b5abd698dc400c599dccb3656ad23591c65b0 Mon Sep 17 00:00:00 2001
+From: "dunno@dunno" <dunno@dunno>
+Date: Tue, 9 Oct 2018 10:40:06 -0400
+Subject: [PATCH 1/3] OpenSSL: bio/b_print(): disable SSE
+
+---
+ Cryptlib/OpenSSL/crypto/bio/b_print.c | 10 ++++++++++
+ 1 file changed, 10 insertions(+)
+
 diff --git a/Cryptlib/OpenSSL/crypto/bio/b_print.c b/Cryptlib/OpenSSL/crypto/bio/b_print.c
-index e91ab6d..f33caa2 100644
+index cdfe05f93ca..6a23c25e168 100644
 --- a/Cryptlib/OpenSSL/crypto/bio/b_print.c
 +++ b/Cryptlib/OpenSSL/crypto/bio/b_print.c
-@@ -51,8 +51,10 @@ static int fmtstr(char **, char **, size_t *, size_t *,
+@@ -31,8 +31,10 @@ static int fmtstr(char **, char **, size_t *, size_t *,
                    const char *, int, int, int);
  static int fmtint(char **, char **, size_t *, size_t *,
-                   LLONG, int, int, int, int);
+                   int64_t, int, int, int, int);
 +#ifndef OPENSSL_SYS_UEFI
  static int fmtfp(char **, char **, size_t *, size_t *,
                   LDOUBLE, int, int, int, int);
@@ -13,17 +22,17 @@ index e91ab6d..f33caa2 100644
  static int doapr_outch(char **, char **, size_t *, size_t *, int);
  static int _dopr(char **sbuffer, char **buffer,
                   size_t *maxlen, size_t *retlen, int *truncated,
-@@ -107,7 +109,9 @@ _dopr(char **sbuffer,
+@@ -87,7 +89,9 @@ _dopr(char **sbuffer,
  {
      char ch;
-     LLONG value;
+     int64_t value;
 +#ifndef OPENSSL_SYS_UEFI
      LDOUBLE fvalue;
 +#endif
      char *strvalue;
      int min;
      int max;
-@@ -210,10 +214,12 @@ _dopr(char **sbuffer,
+@@ -190,10 +194,12 @@ _dopr(char **sbuffer,
                  cflags = DP_C_LLONG;
                  ch = *format++;
                  break;
@@ -36,7 +45,7 @@ index e91ab6d..f33caa2 100644
              default:
                  break;
              }
-@@ -267,6 +273,7 @@ _dopr(char **sbuffer,
+@@ -247,6 +253,7 @@ _dopr(char **sbuffer,
                              min, max, flags))
                      return 0;
                  break;
@@ -44,7 +53,7 @@ index e91ab6d..f33caa2 100644
              case 'f':
                  if (cflags == DP_C_LDOUBLE)
                      fvalue = va_arg(args, LDOUBLE);
-@@ -298,6 +305,7 @@ _dopr(char **sbuffer,
+@@ -280,6 +287,7 @@ _dopr(char **sbuffer,
                             flags, G_FORMAT))
                      return 0;
                  break;
@@ -52,7 +61,7 @@ index e91ab6d..f33caa2 100644
              case 'c':
                  if(!doapr_outch(sbuffer, buffer, &currlen, maxlen,
                              va_arg(args, int)))
-@@ -530,6 +538,7 @@ fmtint(char **sbuffer,
+@@ -512,6 +520,7 @@ fmtint(char **sbuffer,
      return 1;
  }
  
@@ -60,7 +69,7 @@ index e91ab6d..f33caa2 100644
  static LDOUBLE abs_val(LDOUBLE value)
  {
      LDOUBLE result = value;
-@@ -816,6 +825,7 @@ fmtfp(char **sbuffer,
+@@ -798,6 +807,7 @@ fmtfp(char **sbuffer,
      }
      return 1;
  }
@@ -68,3 +77,6 @@ index e91ab6d..f33caa2 100644
  
  #define BUFFER_INC  1024
  
+-- 
+2.17.1
+
diff --git a/Cryptlib/OpenSSL/openssl-pk7-smime-error-message.patch b/Cryptlib/OpenSSL/0002-OpenSSL-Pk7-smime-add-an-error-message.patch
similarity index 58%
rename from Cryptlib/OpenSSL/openssl-pk7-smime-error-message.patch
rename to Cryptlib/OpenSSL/0002-OpenSSL-Pk7-smime-add-an-error-message.patch
index 0b22d69..c559fb1 100644
--- a/Cryptlib/OpenSSL/openssl-pk7-smime-error-message.patch
+++ b/Cryptlib/OpenSSL/0002-OpenSSL-Pk7-smime-add-an-error-message.patch
@@ -1,5 +1,14 @@
+From ea1a0b530ac3b6b9f583a04d17a573e34a7508c8 Mon Sep 17 00:00:00 2001
+From: "dunno@dunno" <dunno@dunno>
+Date: Tue, 9 Oct 2018 10:40:06 -0400
+Subject: [PATCH 2/3] OpenSSL: Pk7/smime: add an error message
+
+---
+ Cryptlib/OpenSSL/crypto/pkcs7/pk7_smime.c | 1 +
+ 1 file changed, 1 insertion(+)
+
 diff --git a/Cryptlib/OpenSSL/crypto/pkcs7/pk7_smime.c b/Cryptlib/OpenSSL/crypto/pkcs7/pk7_smime.c
-index 4418723..5e2107e 100644
+index 44187230ef0..5e2107e969d 100644
 --- a/Cryptlib/OpenSSL/crypto/pkcs7/pk7_smime.c
 +++ b/Cryptlib/OpenSSL/crypto/pkcs7/pk7_smime.c
 @@ -425,6 +425,7 @@ STACK_OF(X509) *PKCS7_get0_signers(PKCS7 *p7, STACK_OF(X509) *certs,
@@ -10,3 +19,6 @@ index 4418723..5e2107e 100644
              return NULL;
          }
      }
+-- 
+2.17.1
+
diff --git a/Cryptlib/OpenSSL/update.sh b/Cryptlib/OpenSSL/update.sh
index 6f9e317..022c51c 100755
--- a/Cryptlib/OpenSSL/update.sh
+++ b/Cryptlib/OpenSSL/update.sh
@@ -1,8 +1,31 @@
 #/bin/sh
+
+set -eu
+
+usage() {
+    echo usage: ./update.sh DIRECTORY 1>&2
+    exit 1
+}
+
+[[ $# -eq 1 ]] || usage
+[[ -n "${1}" ]] || usage
+
 DIR=$1
+
+WORK_PATH=$PWD
 OPENSSLLIB_PATH=$DIR/CryptoPkg/Library/OpensslLib
 OPENSSL_PATH=$OPENSSLLIB_PATH/openssl
 
+cd $OPENSSLLIB_PATH
+perl -I. -Iopenssl/ process_files.pl
+cd $DIR
+git add -A CryptoPkg
+git add CryptoPkg/Library/OpensslLib/openssl/include/openssl/opensslconf.h
+git add CryptoPkg/Library/OpensslLib/openssl/configdata.pm
+git add CryptoPkg/Library/OpensslLib/openssl/Makefile
+git commit -m "Update openssl configs"
+cd $WORK_PATH
+
 cp $OPENSSLLIB_PATH/buildinf.h buildinf.h
 cp $OPENSSL_PATH/e_os.h e_os.h
 
@@ -50,6 +73,7 @@ SUBDIRS="
 	dso
 	err
 	evp
+        fips
 	hmac
 	kdf
 	lhash
@@ -83,5 +107,10 @@ rm -f crypto/x509v3/v3prin.c
 
 find . -name "*.[ch]" -exec chmod -x {} \;
 
-patch -p3 < openssl-bio-b_print-disable-sse.patch
-patch -p3 < openssl-pk7-smime-error-message.patch
+git add -A .
+git commit -m "Update OpenSSL"
+
+git config --local --add am.keepcr true
+git am \
+    0001-OpenSSL-bio-b_print-disable-SSE.patch \
+    0002-OpenSSL-Pk7-smime-add-an-error-message.patch
diff --git a/Cryptlib/opensslconf-diff.patch b/Cryptlib/opensslconf-diff.patch
deleted file mode 100644
index efd2ea4..0000000
--- a/Cryptlib/opensslconf-diff.patch
+++ /dev/null
@@ -1,24 +0,0 @@
-diff --git a/Cryptlib/Include/openssl/opensslconf.h b/Cryptlib/Include/openssl/opensslconf.h
-index 1917d7a..c73d03a 100644
---- a/Cryptlib/Include/openssl/opensslconf.h
-+++ b/Cryptlib/Include/openssl/opensslconf.h
-@@ -47,6 +47,9 @@ extern "C" {
- #ifndef OPENSSL_NO_CT
- # define OPENSSL_NO_CT
- #endif
-+#ifndef OPENSSL_NO_DES
-+# define OPENSSL_NO_DES
-+#endif
- #ifndef OPENSSL_NO_DSA
- # define OPENSSL_NO_DSA
- #endif
-@@ -59,6 +62,9 @@ extern "C" {
- #ifndef OPENSSL_NO_MD2
- # define OPENSSL_NO_MD2
- #endif
-+#ifndef OPENSSL_NO_MD4
-+# define OPENSSL_NO_MD4
-+#endif
- #ifndef OPENSSL_NO_MDC2
- # define OPENSSL_NO_MDC2
- #endif
diff --git a/Cryptlib/update.sh b/Cryptlib/update.sh
index 8983ad0..8bcbc3a 100755
--- a/Cryptlib/update.sh
+++ b/Cryptlib/update.sh
@@ -1,6 +1,36 @@
 #!/bin/bash
 
-DIR=$1
+set -eu
+
+usage() {
+    echo usage: ./update.sh DIRECTORY 1>&2
+    exit 1
+}
+
+test_dir() {
+    if [[ -d "${1}/CryptoPkg/Library/BaseCryptLib/" ]] && \
+       [[ -d "${1}/CryptoPkg/Library/Include/internal/" ]] && \
+       [[ -d "${1}/CryptoPkg/Library/OpensslLib/openssl/" ]] ; then
+        DIR="$(realpath "${1}")"
+        return 0
+    fi
+    return 1
+}
+
+TAG=$(mktemp -p shim -t -u 'shim-tag-XXXXXXXXXX' | cut -d/ -f2)
+git tag "${TAG}"
+
+git list --topo-order --reverse openssl-rebase-helper-start^..openssl-rebase-helper-end | cut -d\  -f1 | xargs git cherry-pick
+
+if [[ $# -eq 1 ]] ; then
+    test_dir "${1}" || usage
+else
+    test_dir .. || usage
+fi
+
+cd OpenSSL
+./update.sh $DIR
+cd ..
 
 cp $DIR/CryptoPkg/Library/BaseCryptLib/InternalCryptLib.h InternalCryptLib.h
 cp $DIR/CryptoPkg/Library/BaseCryptLib/Hash/CryptMd4Null.c Hash/CryptMd4Null.c
@@ -34,6 +64,19 @@ cp $DIR/CryptoPkg/Library/Include/internal/dso_conf.h Include/internal/
 
 cp $DIR/CryptoPkg/Library/Include/openssl/opensslconf.h Include/openssl/
 
-patch -p2 <Cryptlib.diff
-patch -p2 <opensslconf-diff.patch
-patch -p2 <ca-check-workaround.patch
+git add -A .
+git commit -m "Update Cryptlib"
+
+git config --local --add am.keepcr true
+git am \
+    0001-Cryptlib-update-for-efi-build.patch \
+    0002-Cryptlib-work-around-new-CA-rules.patch \
+    0003-Cryptlib-Pk-CryptX509.c-Fix-RETURN_-to-be-EFI_.patch
+
+cd $DIR
+git rm -r CryptoPkg
+git commit -m "Get rid of the vestigial CryptoPkg"
+git reset "${TAG}"
+git add -A Cryptlib/
+git commit -m "Update Cryptlib and OpenSSL"
+git tag -d "${TAG}"
-- 
2.17.1

