From 9a34470c7fd4aefea43522e63b3f757b31456e87 Mon Sep 17 00:00:00 2001
From: Peter Jones <pjones@redhat.com>
Date: Wed, 11 Apr 2018 16:34:26 -0400
Subject: [PATCH 03/55] Update travis to use some better build scripts

Signed-off-by: Peter Jones <pjones@redhat.com>
---
 .travis.yml     | 10 ++------
 travis-build.sh | 62 -------------------------------------------------
 2 files changed, 2 insertions(+), 70 deletions(-)
 delete mode 100755 travis-build.sh

diff --git a/.travis.yml b/.travis.yml
index 534bd1e..6cebdbc 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -11,13 +11,7 @@ matrix:
      services: docker
 
 before_install:
-  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker pull vathpela/shim-travis-rawhide:v2 ; fi
-
-before_script:
-  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then echo FROM vathpela/shim-travis-rawhide:v2 > Dockerfile ; fi
-  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then echo ADD . /root >> Dockerfile ; fi
-  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker build -t withgit . ; fi
+  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker pull vathpela/efi-ci-rawhide:v0 ; fi
 
 script:
-  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker run --volume $HOME/.ccache:/root/.ccache withgit /bin/sh -c "cd /root/shim && git pull && git reset origin/master --hard && ./travis-build.sh --branch $TRAVIS_BRANCH --repo \"$TRAVIS_REPO_SLUG\" --remote \"$TRAVIS_PULL_REQUEST_SLUG\" --pr-sha \"$TRAVIS_PULL_REQUEST_SHA\"" ; fi
-  - ccache -s
+  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker run vathpela/efi-ci-rawhide:v0 /bin/sh -c "cd /root/ && ./build.sh --branch \"$TRAVIS_BRANCH\" --commit \"$TRAVIS_COMMIT\" --commit-range \"$TRAVIS_COMMIT_RANGE\" --event-type \"$TRAVIS_EVENT_TYPE\" --pull-request \"$TRAVIS_PULL_REQUEST\" --pr-branch \"$TRAVIS_PULL_REQUEST_BRANCH\" --pr-sha \"$TRAVIS_PULL_REQUEST_SHA\" --remote \"$TRAVIS_PULL_REQUEST_SLUG\" --repo \"$TRAVIS_REPO_SLUG\" --test-subject shim" ; fi
diff --git a/travis-build.sh b/travis-build.sh
deleted file mode 100755
index 3b8745b..0000000
--- a/travis-build.sh
+++ /dev/null
@@ -1,62 +0,0 @@
-#!/bin/bash
-#
-# travis-build.sh
-# Copyright (C) 2018 Peter Jones <pjones@redhat.com>
-#
-# Distributed under terms of the GPLv3 license.
-#
-#
-
-set -euv
-
-usage() {
-    echo usage: $1 --branch '<origin_branch>' --repo '<origin_repo>' --remote '<remote_repo>' --pr-sha '<commit_id>'
-    exit $2
-}
-
-declare origin_branch=""
-declare origin_repo=""
-declare remote_repo=""
-declare pr_sha=""
-
-let n=0 || :
-
-if [[ $# -le 1 ]] ; then
-    usage $0 1
-fi
-
-while [[ $# > 0 ]] ; do
-    case " $1 " in
-        " --help "|" -h "|" -? ")
-            usage $0 0
-            ;;
-        " --branch ")
-            origin_branch="$2"
-            shift
-            ;;
-        " --repo ")
-            origin_repo="$2"
-            shift
-            ;;
-        " --remote ")
-            remote_repo="$2"
-            shift
-            ;;
-        " --pr-sha ")
-            commit_id="$2"
-            shift
-            ;;
-        *)
-            usage $0 1
-            ;;
-    esac
-    shift
-done
-
-if [[ -n "${remote_repo}" ]] ; then
-    git remote add remote https://github.com/${remote_repo}
-    git fetch remote
-    git checkout -f ${commit_id}
-fi
-git reset --hard "${origin_branch}"
-make EFIDIR=test ENABLE_SHIM_CERT=1 ENABLE_HTTBOOT=1 ARCH=x86_64 clean all
-- 
2.17.1

